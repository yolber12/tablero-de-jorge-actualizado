
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Patrocinios - Jorge Dos Santos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8f9fa; /* Fondo m√°s claro */
            min-height: 100vh; 
        }
        /* Estilos del Kanban */
        .kanban-container { 
            display: flex; 
            overflow-x: auto; 
            gap: 1.5rem; /* gap-6 */
            padding-bottom: 1rem; /* Espacio para la barra de desplazamiento */
        }
        .kanban-column { 
            min-width: 300px; 
            max-width: 300px; 
            flex-shrink: 0;
            background-color: #ffffff; 
            border: 1px solid #e9ecef; /* Borde m√°s sutil */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); 
            border-radius: 1rem; /* rounded-xl */
            transition: all 0.3s ease-in-out;
        }
        
        /* Estilos de la Columna PERDIDO */
        #lost {
            background-color: #1f2937; /* Gris oscuro para archivo */
            color: #f9fafb; /* Texto blanco */
        }
        #lost .kanban-title, #lost .kanban-count {
            color: #f9fafb !important;
        }

        /* Estilos de la Tarjeta */
        .card { 
            cursor: grab; 
            transition: transform 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease; 
            border-radius: 0.75rem; /* rounded-lg */
            margin-bottom: 1rem; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border-left-width: 5px; /* Usar border-left para el color */
            border-style: solid;
        }
        .card:hover { 
            box-shadow: 0 8px 10px -1px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
            transform: translateY(-2px); /* Ligera elevaci√≥n al pasar el mouse */
        }
        .card:active { 
            cursor: grabbing; 
            transform: scale(0.98); /* Ligera compresi√≥n al arrastrar */
        }
        
        /* Clases de Riesgo */
        .risk-orange { border-color: #f97316 !important; background-color: #fff7ed !important; }
        .risk-red { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        
        /* Responsive para la estructura de las tarjetas de resumen */
        @media (max-width: 640px) {
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 641px) and (max-width: 1024px) {
            .summary-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        @media (min-width: 1025px) {
             .summary-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        /* Estilos del Gr√°fico de Embudo */
        .funnel-bar {
            height: 25px;
            display: flex;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .funnel-segment {
            transition: width 0.5s ease-out;
            text-align: center;
            line-height: 25px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <header class="mb-8 p-6 bg-white rounded-2xl shadow-2xl border-t-4 border-indigo-600">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between">
            <div class="mb-4 md:mb-0">
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-2 flex items-center">
                    <i data-lucide="car" class="w-7 h-7 mr-3 text-indigo-700"></i>
                    Dashboard de Patrocinios
                </h1>
                <p class="text-lg text-gray-600" id="sync-status">Conectando a la base de datos...</p>
            </div>
            <span id="connection-status" class="text-sm bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full font-semibold ml-0 md:ml-4 shadow-inner flex-shrink-0">
                Conectando...
            </span>
        </div>
        
        <!-- Tarjetas de Resumen de Capital -->
        <div class="mt-6 summary-grid grid gap-4">
            
            <!-- Capital en Negociaci√≥n (Filtrado) -->
            <div class="p-5 bg-blue-50 rounded-xl shadow-lg border-b-4 border-blue-500 transition-all duration-300 hover:shadow-xl">
                <p class="text-sm font-semibold text-blue-700 uppercase mb-1">En Negociaci√≥n (Filtro)</p>
                <div class="flex items-center justify-between">
                    <span id="capital-negotiation" class="text-2xl font-extrabold text-blue-800">$0.00</span>
                    <i data-lucide="bar-chart-2" class="w-6 h-6 text-blue-500"></i>
                </div>
            </div>

            <!-- Capital Pendiente de Pago (Filtrado) -->
            <div class="p-5 bg-yellow-50 rounded-xl shadow-lg border-b-4 border-yellow-500 transition-all duration-300 hover:shadow-xl">
                <p class="text-sm font-semibold text-yellow-700 uppercase mb-1">Pendiente de Pago (Filtro)</p>
                <div class="flex items-center justify-between">
                    <span id="capital-pending" class="text-2xl font-extrabold text-yellow-800">$0.00</span>
                    <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-500"></i>
                </div>
            </div>

            <!-- Capital Recibido (Pagado) (Filtrado) -->
            <div class="p-5 bg-green-50 rounded-xl shadow-lg border-b-4 border-green-500 transition-all duration-300 hover:shadow-xl">
                <p class="text-sm font-semibold text-green-700 uppercase mb-1">Capital Recibido (Filtro)</p>
                <div class="flex items-center justify-between">
                    <span id="capital-paid" class="text-2xl font-extrabold text-green-800">$0.00</span>
                    <i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>
                </div>
            </div>
            
            <!-- Gr√°fico de Embudo y Total Proyectado -->
            <div class="lg:col-span-2 p-5 bg-indigo-50 rounded-xl shadow-xl border-t-4 border-indigo-600">
                <p class="text-sm font-semibold text-indigo-700 uppercase mb-1">Capital Proyectado Total (Filtro)</p>
                <div class="flex items-center justify-between mb-3">
                    <span id="total-amount" class="text-2xl font-extrabold text-indigo-800">$0.00</span>
                    <i data-lucide="trending-up" class="w-6 h-6 text-indigo-500"></i>
                </div>
                <!-- FUNNEL BAR -->
                <div class="funnel-bar">
                    <div id="funnel-negotiation" class="funnel-segment bg-blue-500" style="width: 0%"></div>
                    <div id="funnel-pending" class="funnel-segment bg-yellow-500" style="width: 0%"></div>
                    <div id="funnel-paid" class="funnel-segment bg-green-500" style="width: 0%"></div>
                </div>
                <div class="mt-2 text-xs text-gray-500 flex justify-between">
                    <span>Negociaci√≥n</span>
                    <span>Pagado</span>
                </div>
            </div>

            <!-- Capital Total Hist√≥rico Recibido (SIN FILTRO) -->
            <div class="p-5 bg-gray-100 rounded-xl shadow-lg border-b-4 border-gray-600 transition-all duration-300 hover:shadow-xl">
                <p class="text-sm font-semibold text-gray-700 uppercase mb-1">Total Generado Hist√≥rico (PAGADO)</p>
                <div class="flex items-center justify-between">
                    <span id="historical-total-paid" class="text-2xl font-extrabold text-gray-800">$0.00</span>
                    <i data-lucide="wallet" class="w-6 h-6 text-gray-600"></i>
                </div>
            </div>

        </div>
        
        <!-- Controles de Filtro -->
        <div class="mt-6 space-y-4 md:space-y-0 md:flex md:justify-between md:items-center">
            
            <!-- Filtros por Fecha -->
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner border border-gray-200 flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4 items-stretch md:items-center w-full md:w-auto">
                <label class="font-bold text-gray-700 text-base flex items-center">
                    <i data-lucide="calendar" class="w-5 h-5 mr-2 text-indigo-500"></i>
                    Filtrar por:
                </label>
                <select id="filter-year" class="p-2 border border-gray-300 rounded-lg text-sm bg-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500 w-full md:w-auto transition-colors" onchange="applyFilter()">
                    <option value="all">Todo el Historial</option>
                </select>
                <select id="filter-month" class="p-2 border border-gray-300 rounded-lg text-sm bg-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500 w-full md:w-auto transition-colors" onchange="applyFilter()">
                    <option value="all">Todos los Meses</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
            </div>
        </div>
        
    </header>

    <main class="kanban-container">
        <!-- Columna NEGOCIACI√ìN -->
        <div id="negotiation" class="kanban-column p-4 flex flex-col h-full" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'negotiation')" ondragleave="handleDragLeave(event)">
            <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2 flex items-center justify-between">
                <div class="flex items-center">
                    <i data-lucide="clock" class="w-5 h-5 mr-2 text-blue-500"></i>
                    Fase I: Negociaci√≥n
                </div>
                <span class="ml-2 text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-semibold" id="negotiation-count">0</span>
            </h2>
            <button id="add-sponsorship-btn" class="mb-4 w-full flex items-center justify-center px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md transform hover:scale-[1.01]">
                <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                A√±adir Oportunidad
            </button>
            <div id="add-form-container" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg shadow-inner hidden">
                <form id="add-sponsorship-form">
                    <input type="text" id="sponsorship-name" placeholder="Nombre de la Marca" required class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="number" id="sponsorship-amount" placeholder="Monto (ej: 1500)" required class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" min="0">
                    <textarea id="sponsorship-notes" placeholder="Notas clave" rows="2" class="w-full p-2 mb-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    <div class="flex justify-between space-x-2">
                        <button type="submit" class="flex-1 px-3 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition shadow-sm">Guardar</button>
                        <button type="button" id="cancel-add-btn" class="px-3 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition flex items-center shadow-sm">
                            <i data-lucide="x-circle" class="w-4 h-4 mr-1"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
            <!-- Selector de Ordenamiento -->
            <div class="mb-4 flex items-center">
                <i data-lucide="arrow-up-down" class="w-4 h-4 mr-2 text-gray-500"></i>
                <select id="sort-negotiation" class="p-2 border border-gray-300 rounded-lg text-sm w-full bg-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-colors" onchange="sortColumn('negotiation', this.value)">
                    <option value="default">Ordenar por...</option>
                    <option value="amount_desc">Monto Mayor</option>
                    <option value="amount_asc">Monto Menor</option>
                    <option value="name_asc">Nombre A-Z</option>
                    <option value="name_desc">Nombre Z-A</option>
                </select>
            </div>
            <div id="negotiation-list" class="space-y-4 flex-grow"></div>
        </div>

        <!-- Columna PENDIENTE -->
        <div id="pending" class="kanban-column p-4 flex flex-col h-full" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'pending')" ondragleave="handleDragLeave(event)">
            <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2 flex items-center justify-between">
                <div class="flex items-center">
                    <i data-lucide="dollar-sign" class="w-5 h-5 mr-2 text-yellow-500"></i>
                    Fase II: Acuerdos en Cierre
                </div>
                <span class="ml-2 text-sm bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full font-semibold" id="pending-count">0</span>
            </h2>
            <!-- Selector de Ordenamiento -->
            <div class="mb-4 flex items-center">
                <i data-lucide="arrow-up-down" class="w-4 h-4 mr-2 text-gray-500"></i>
                <select id="sort-pending" class="p-2 border border-gray-300 rounded-lg text-sm w-full bg-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-colors" onchange="sortColumn('pending', this.value)">
                    <option value="default">Ordenar por...</option>
                    <option value="amount_desc">Monto Mayor</option>
                    <option value="amount_asc">Monto Menor</option>
                    <option value="name_asc">Nombre A-Z</option>
                    <option value="name_desc">Nombre Z-A</option>
                </select>
            </div>
            <div id="pending-list" class="space-y-4 flex-grow"></div>
        </div>

        <!-- Columna PAGADO -->
        <div id="paid" class="kanban-column p-4 flex flex-col h-full" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'paid')" ondragleave="handleDragLeave(event)">
            <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2 flex items-center justify-between">
                <div class="flex items-center">
                    <i data-lucide="check-circle" class="w-5 h-5 mr-2 text-green-500"></i>
                    Fase III: Capital Recibido
                </div>
                <span class="ml-2 text-sm bg-green-100 text-green-700 px-3 py-1 rounded-full font-semibold" id="paid-count">0</span>
            </h2>
            <!-- Selector de Ordenamiento -->
            <div class="mb-4 flex items-center">
                <i data-lucide="arrow-up-down" class="w-4 h-4 mr-2 text-gray-500"></i>
                <select id="sort-paid" class="p-2 border border-gray-300 rounded-lg text-sm w-full bg-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-colors" onchange="sortColumn('paid', this.value)">
                    <option value="default">Ordenar por...</option>
                    <option value="amount_desc">Monto Mayor</option>
                    <option value="amount_asc">Monto Menor</option>
                    <option value="name_asc">Nombre A-Z</option>
                    <option value="name_desc">Nombre Z-A</option>
                </select>
            </div>
            <div id="paid-list" class="space-y-4 flex-grow"></div>
        </div>

        <!-- Columna PERDIDO -->
        <div id="lost" class="kanban-column p-4 flex flex-col h-full" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'lost')" ondragleave="handleDragLeave(event)">
            <h2 class="text-xl font-bold mb-4 kanban-title border-b pb-2 flex items-center justify-between">
                <div class="flex items-center">
                    <i data-lucide="x-circle" class="w-5 h-5 mr-2 text-red-400"></i>
                    Oportunidades Perdidas
                </div>
                <span class="ml-2 text-sm bg-gray-700 text-red-300 px-3 py-1 rounded-full font-semibold kanban-count" id="lost-count">0</span>
            </h2>
            <!-- Selector de Ordenamiento -->
            <div class="mb-4 flex items-center text-gray-300">
                <i data-lucide="arrow-up-down" class="w-4 h-4 mr-2 text-gray-400"></i>
                <select id="sort-lost" class="p-2 border border-gray-600 rounded-lg text-sm w-full bg-gray-700 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-colors text-gray-100" onchange="sortColumn('lost', this.value)">
                    <option value="default">Ordenar por...</option>
                    <option value="amount_desc">Monto Mayor</option>
                    <option value="amount_asc">Monto Menor</option>
                    <option value="name_asc">Nombre A-Z</option>
                    <option value="name_desc">Nombre Z-A</option>
                </select>
            </div>
            <div id="lost-list" class="space-y-4 flex-grow"></div>
        </div>
    </main>

    <!-- Modal de ACCI√ìN/CONFIRMACI√ìN -->
    <div id="action-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50 transition-opacity duration-300 ease-out">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform scale-100 transition-transform duration-300 ease-out">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">Confirmar Acci√≥n</h3>
            <p id="modal-message" class="mb-6 text-gray-600"></p>
            <!-- Campo opcional para Motivo de P√©rdida -->
            <div id="loss-reason-field" class="hidden mb-6">
                <label for="loss-reason" class="block text-sm font-medium text-gray-700 mb-2">Motivo de la P√©rdida</label>
                <textarea id="loss-reason" rows="2" class="w-full p-2 border border-red-300 rounded-lg bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors" placeholder="Ej: Precio de la competencia, Presupuesto agotado"></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors transform hover:scale-[1.02]">Cancelar</button>
                <button id="modal-confirm" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors transform hover:scale-[1.02] shadow-md">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de EDICI√ìN (para ver/modificar detalles) -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50 transition-opacity duration-300 ease-out">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg transform scale-100 transition-transform duration-300 ease-out">
            <h3 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2 flex items-center justify-between">
                Detalles del Patrocinio
                <button id="edit-modal-close" class="text-gray-400 hover:text-indigo-600 transition-colors p-1 rounded-full hover:bg-gray-100">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </h3>
            <form id="edit-sponsorship-form">
                <input type="hidden" id="edit-sponsorship-id">
                
                <div class="mb-4">
                    <label for="edit-sponsorship-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Marca</label>
                    <input type="text" id="edit-sponsorship-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">
                </div>

                <div class="mb-4">
                    <label for="edit-sponsorship-amount" class="block text-sm font-medium text-gray-700 mb-1">Monto Proyectado ($)</label>
                    <input type="number" id="edit-sponsorship-amount" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors" min="0">
                </div>
                
                <div class="mb-6">
                    <label for="edit-sponsorship-notes" class="block text-sm font-medium text-gray-700 mb-1">Notas Clave</label>
                    <textarea id="edit-sponsorship-notes" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors"></textarea>
                </div>
                
                <!-- Campo de Motivo de P√©rdida (solo visible si status es 'lost') -->
                <div id="edit-loss-reason-container" class="mb-6 hidden p-3 bg-red-50 border border-red-300 rounded-lg">
                    <label for="edit-loss-reason" class="block text-sm font-medium text-red-700 mb-1">Motivo por el que se Perdi√≥</label>
                    <textarea id="edit-loss-reason" rows="2" class="w-full p-3 border border-red-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors"></textarea>
                </div>
                
                <div class="text-sm text-gray-500 mb-4 border-t pt-2" id="last-activity-display">√öltima actividad: N/A</div>

                <div class="flex flex-col sm:flex-row justify-between items-center border-t pt-4 space-y-3 sm:space-y-0">
                    <button type="button" id="delete-sponsorship-btn" class="flex items-center px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition shadow-md transform hover:scale-[1.02] w-full sm:w-auto justify-center">
                        <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i>
                        Eliminar Patrocinio
                    </button>
                    <button type="submit" class="flex items-center px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition shadow-lg transform hover:scale-[1.02] w-full sm:w-auto justify-center">
                        <i data-lucide="save" class="w-5 h-5 mr-2"></i>
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- SCRIPTS DE FIREBASE CON LAS LIBRER√çAS COMPAT -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // CONFIGURACI√ìN DE FIREBASE - Mantenida como est√° en tu repositorio
        const firebaseConfig = {
            apiKey: "AIzaSyA1UPMYdUxOPfBpExXsdWJO_AUjaqW4x5U",
            authDomain: "tablero-jorge.firebaseapp.com",
            projectId: "tablero-jorge",
            storageBucket: "tablero-jorge.firebasestorage.app",
            messagingSenderId: "385852863891",
            appId: "1:385852863891:web:48a6fbaaa19fb7cbbd588"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        lucide.createIcons();

        let allSponsorships = []; 
        let isOnline = false;
        // La l√≥gica de ordenamiento se mantiene
        let columnSorts = { negotiation: 'default', pending: 'default', paid: 'default', lost: 'default' }; 
        let draggedId = null; 
        
        // --- UMBRALES DE VALOR ---
        const DIAMOND_THRESHOLD = 1999; // > $1999 (>= $2000)
        const GOLD_THRESHOLD = 999;     // > $999 (>= $1000)
        const BRONZE_THRESHOLD = 549;   // > $549 (>= $550) 
        // --- FIN UMBRALES DE VALOR ---


        // --- UTILIDADES DE FECHA ---
        function safeToDate(timestamp) {
            if (!timestamp) return null;
            // Manejar objetos Timestamp de Firestore o Strings/n√∫meros si ya fueron convertidos o son de datos de ejemplo.
            return timestamp.toDate ? timestamp.toDate() : new Date(timestamp); 
        }

        // --- INICIALIZACI√ìN Y CONEXI√ìN ---
        async function initFirebase() {
            try {
                updateConnectionStatus('connecting');
                
                populateYearFilter();

                // Usamos signInAnonymously como fallback seguro para pruebas
                await auth.signInAnonymously(); 

                setupRealtimeListener();
                setupFormListeners();
                setupModalListeners();
                
            } catch (error) {
                console.error("‚ùå Error Firebase:", error);
                updateConnectionStatus('error');
                showConfirmationModal('Error de Conexi√≥n', 
                    `No se pudo conectar a Firebase. Error: ${error.message}`, 
                    () => {}
                );
            }
        }

        function updateConnectionStatus(status) {
            const element = document.getElementById('connection-status');
            const syncText = document.getElementById('sync-status');
            
            element.classList.remove('bg-green-100', 'bg-red-100', 'bg-yellow-100', 'text-green-700', 'text-red-700', 'text-yellow-700');
            
            if (status === 'connected') {
                element.textContent = 'Conectado ‚úì';
                element.classList.add('bg-green-100', 'text-green-700');
                syncText.textContent = 'Sincronizado en tiempo real';
                syncText.classList.remove('text-gray-600', 'text-red-600');
                syncText.classList.add('text-green-600');
                isOnline = true;
            } else if (status === 'error') {
                element.textContent = 'Error de Conexi√≥n ‚úó';
                element.classList.add('bg-red-100', 'text-red-700');
                syncText.textContent = 'Modo local (sin sincronizaci√≥n)';
                syncText.classList.remove('text-gray-600', 'text-green-600');
                syncText.classList.add('text-red-600');
                isOnline = false;
                showExampleData();
            } else {
                element.textContent = 'Conectando...';
                element.classList.add('bg-yellow-100', 'text-yellow-700');
                syncText.textContent = 'Conectando a la base de datos...';
                syncText.classList.remove('text-green-600', 'text-red-600');
                syncText.classList.add('text-gray-600');
            }
        }

        function setupRealtimeListener() {
            db.collection('sponsorships').onSnapshot((snapshot) => {
                allSponsorships = [];
                const years = new Set();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const sponsorship = {
                        id: doc.id,
                        ...data,
                        // Convertir timestamps de Firestore a objeto Date de JavaScript
                        createdAt: safeToDate(data.createdAt), 
                        lastActivityDate: safeToDate(data.lastActivityDate) || safeToDate(data.createdAt), // Usar createdAt si lastActivityDate no existe
                        // Eliminamos isStarred de la l√≥gica y la data
                    };
                    allSponsorships.push(sponsorship);
                    if (sponsorship.createdAt instanceof Date) {
                        years.add(sponsorship.createdAt.getFullYear());
                    }
                });
                
                populateYearFilter(Array.from(years));
                applyFilter();
                updateConnectionStatus('connected');
                
            }, (error) => {
                console.error("‚ùå Error en listener:", error);
                updateConnectionStatus('error');
            });
        }
        
        function populateYearFilter(yearList = []) {
            const yearSelect = document.getElementById('filter-year');
            const currentSelectedYear = yearSelect.value;
            
            const optionsToKeep = yearSelect.querySelector('option[value="all"]').outerHTML;
            yearSelect.innerHTML = optionsToKeep;

            const sortedYears = Array.from(new Set(yearList)).sort((a, b) => b - a);

            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            
            if (currentSelectedYear && yearSelect.querySelector(`option[value="${currentSelectedYear}"]`)) {
                yearSelect.value = currentSelectedYear;
            }
        }

        function showExampleData() {
            const now = new Date();
            const eightDaysAgo = new Date(now.getTime() - 8 * 24 * 60 * 60 * 1000);
            const elevenDaysAgo = new Date(now.getTime() - 11 * 24 * 60 * 60 * 1000);
            const twoDaysAgo = new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000);
            
            const exampleData = [
                { id: '1', name: 'Moss (Diamante)', amount: 2500, status: 'negotiation', notes: 'Sin respuesta en 8 d√≠as.', createdAt: twoDaysAgo, lastActivityDate: eightDaysAgo },
                { id: '2', name: 'Puma (Bronce)', amount: 600, status: 'negotiation', notes: 'Revisi√≥n final de contrato.', createdAt: twoDaysAgo, lastActivityDate: now },
                { id: '3', name: 'Gp (Pagado)', amount: 1000, status: 'paid', notes: 'Pagado en cash. Cerrado.', createdAt: twoDaysAgo, lastActivityDate: twoDaysAgo },
                { id: '4', name: 'Arcoweld (Perdido)', amount: 700, status: 'lost', notes: 'El cliente se fue con la competencia.', lossReason: 'Precio de la competencia' , createdAt: twoDaysAgo, lastActivityDate: twoDaysAgo },
                { id: '5', name: 'Mi casino (Diamante)', amount: 4500, status: 'negotiation', notes: 'Sin respuesta en 11 d√≠as.', createdAt: twoDaysAgo, lastActivityDate: elevenDaysAgo },
                { id: '6', name: 'Solverapp (Oro)', amount: 1550, status: 'pending', notes: 'Pendiente de transferencia.', createdAt: twoDaysAgo, lastActivityDate: eightDaysAgo },
                { id: '7', name: 'Zeta Corp (Pendiente)', amount: 1200, status: 'pending', notes: 'Firma de acuerdo pendiente', createdAt: twoDaysAgo, lastActivityDate: now }
            ];
            
            allSponsorships = exampleData;
            // Asegurar que las fechas se conviertan a Date para el renderizado
            allSponsorships.forEach(s => {
                s.createdAt = new Date(s.createdAt);
                s.lastActivityDate = new Date(s.lastActivityDate);
            });
            applyFilter();
        }

        // --- L√ìGICA DE FILTRADO ---

        function applyFilter() {
            renderSponsorships(); 
        }


        // --- CRUD EN FIREBASE ---
        async function updateSponsorship(id, data, updateActivityDate = true) {
            // Validar el ID antes de usar doc()
            if (!id || typeof id !== 'string' || id.trim() === '') {
                console.error("üö´ Error: ID de patrocinio inv√°lido o vac√≠o. No se puede actualizar.");
                showConfirmationModal('Error de Datos', 'ID de patrocinio no encontrado. No se puede realizar la actualizaci√≥n.', () => {});
                return;
            }

            if (!isOnline) {
                showConfirmationModal('Sin Conexi√≥n', 'No hay conexi√≥n a Internet. Los cambios no se guardar√°n.', () => {});
                return;
            }
            
            const updatePayload = {
                ...data,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Actualizar lastActivityDate si no se est√° marcando como perdido y si se solicita
            if (updateActivityDate && data.status !== 'lost') {
                updatePayload.lastActivityDate = firebase.firestore.FieldValue.serverTimestamp();
            }

            try {
                await db.collection('sponsorships').doc(id).update(updatePayload);
                console.log(`‚úÖ Actualizado: ${id}`);
            } catch (error) {
                console.error("Error actualizando:", error);
                showConfirmationModal('Error', `No se pudo actualizar el patrocinio. Error: ${error.message}`, () => {});
            }
        }
        
        async function updateSponsorshipStatus(id, newStatus, lossReason = null) {
            const updateData = { status: newStatus };
            let updateActivity = true; 

            if (newStatus === 'lost') {
                updateData.lossReason = lossReason;
                // No actualizamos lastActivityDate al pasar a 'lost'
                updateActivity = false; 
            } else {
                updateData.lossReason = firebase.firestore.FieldValue.delete();
            }
            
            await updateSponsorship(id, updateData, updateActivity);
        }
        
        async function deleteSponsorship(id) {
            // Validar el ID antes de usar doc()
            if (!id || typeof id !== 'string' || id.trim() === '') {
                console.error("üö´ Error: ID de patrocinio inv√°lido o vac√≠o. No se puede eliminar.");
                showConfirmationModal('Error de Datos', 'ID de patrocinio no encontrado. No se puede realizar la eliminaci√≥n.', () => {});
                return;
            }
            
            if (!isOnline) {
                showConfirmationModal('Sin Conexi√≥n', 'No hay conexi√≥n a Internet. No se puede eliminar.', () => {});
                return;
            }

            try {
                await db.collection('sponsorships').doc(id).delete();
                console.log(`üóëÔ∏è Eliminado: ${id}`);
                hideEditModal();
            } catch (error) {
                console.error("Error eliminando:", error);
                showConfirmationModal('Error', 'No se pudo eliminar. Revisa la conexi√≥n.', () => {});
            }
        }

        // --- FUNCI√ìN DE AGREGAR: Inicializa lastActivityDate ---
        async function addSponsorship(name, amount, notes) {
            if (!isOnline) {
                showConfirmationModal('Sin Conexi√≥n', 'No hay conexi√≥n. No se puede agregar nuevo patrocinio.', () => {});
                return false;
            }
            
            // 1. Obtener los valores del filtro
            const selectedYear = document.getElementById('filter-year').value;
            const selectedMonth = document.getElementById('filter-month').value;
            
            let creationDate;
            
            if (selectedYear !== 'all' && selectedMonth !== 'all') {
                creationDate = new Date(parseInt(selectedYear), parseInt(selectedMonth) - 1, 15);
            } else {
                creationDate = firebase.firestore.FieldValue.serverTimestamp();
            }

            try {
                await db.collection('sponsorships').add({
                    name: name,
                    amount: parseFloat(amount),
                    notes: notes,
                    status: 'negotiation',
                    createdAt: creationDate,
                    lastActivityDate: creationDate, // Inicializar la actividad con la fecha de creaci√≥n
                });
                
                // Resetear el formulario y UI
                const addForm = document.getElementById('add-sponsorship-form');
                const formContainer = document.getElementById('add-form-container');
                const addBtn = document.getElementById('add-sponsorship-btn');
                addForm.reset();
                formContainer.classList.add('hidden');
                addBtn.classList.remove('hidden');
                
                return true;
            } catch (error) {
                console.error("Error agregando:", error);
                showConfirmationModal('Error', 'No se pudo guardar. Revisa la conexi√≥n.', () => {});
                return false;
            }
        }

        // --- L√ìGICA DE ORDENAMIENTO Y RENDERIZADO ---
        function sortColumn(status, sortBy) {
            columnSorts[status] = sortBy;
            renderSponsorships();
        }
        
        function getSortedSponsorships(status) {
            const selectedYear = document.getElementById('filter-year').value;
            const selectedMonth = document.getElementById('filter-month').value;
            
            let columnSponsorships = allSponsorships.filter(s => s.status === status);

            // Filtrado por fecha: SOLO aplica a columnas de Capital (negotiation, pending, paid)
            if (['negotiation', 'pending', 'paid'].includes(status)) {
                 columnSponsorships = columnSponsorships.filter(sponsorship => {
                    const date = sponsorship.createdAt;
                    // Si no tiene fecha de creaci√≥n o no es un objeto Date, lo incluimos
                    if (!date || !(date instanceof Date)) return true; 

                    const isYearMatch = selectedYear === 'all' || date.getFullYear().toString() === selectedYear;
                    const isMonthMatch = selectedMonth === 'all' || (date.getMonth() + 1).toString() === selectedMonth;

                    return isYearMatch && isMonthMatch;
                });
            }

            const sortBy = columnSorts[status];
            
            // Funci√≥n de comparaci√≥n para ordenar
            const compare = (a, b) => {
                
                switch (sortBy) {
                    case 'amount_desc':
                        return (b.amount || 0) - (a.amount || 0);
                    case 'amount_asc':
                        return (a.amount || 0) - (b.amount || 0);
                    case 'name_asc':
                        return a.name.localeCompare(b.name);
                    case 'name_desc':
                        return b.name.localeCompare(a.name);
                    case 'default':
                    default:
                        // Por defecto, ordenar por √∫ltima actividad m√°s reciente
                        return (b.lastActivityDate?.getTime() || 0) - (a.lastActivityDate?.getTime() || 0);
                }
            };
            
            columnSponsorships.sort(compare);
            return columnSponsorships;
        }

        function formatDate(date) {
            if (!date || !(date instanceof Date)) return 'N/A';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function getRiskClasses(sponsorship) {
            if (sponsorship.status === 'lost' || sponsorship.status === 'paid') {
                return '';
            }

            const now = new Date();
            const lastActivity = sponsorship.lastActivityDate;
            
            if (!lastActivity || !(lastActivity instanceof Date)) return '';
            
            // Diferencia en milisegundos
            const diffTime = Math.abs(now.getTime() - lastActivity.getTime());
            // Diferencia en d√≠as
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            // ALERTA ROJA: M√°s de 10 d√≠as sin actividad
            if (diffDays > 10) {
                return 'risk-red'; 
            } 
            // ALERTA NARANJA: M√°s de 7 d√≠as sin actividad
            else if (diffDays > 7) {
                return 'risk-orange'; 
            }
            return ''; 
        }

        function getValueIcon(amount) {
            if (amount > DIAMOND_THRESHOLD) {
                // Diamante Azul (Alto Valor)
                return `<i data-lucide="gem" class="w-4 h-4 text-blue-500 ml-2 fill-blue-500"></i>`;
            } else if (amount > GOLD_THRESHOLD) {
                // Piedra de Oro Amarilla
                return `<i data-lucide="star" class="w-4 h-4 text-yellow-500 ml-2 fill-yellow-500"></i>`;
            } else if (amount > BRONZE_THRESHOLD) {
                // Piedra de Bronce Marr√≥n
                return `<i data-lucide="shield-half" class="w-4 h-4 text-amber-800 ml-2 fill-amber-800"></i>`;
            }
            return '';
        }

        function createCardElement(sponsorship) {
            const card = document.createElement('div');
            
            // Clase de columna perdida para opacidad
            const lostOpacityClass = sponsorship.status === 'lost' ? 'opacity-75 hover:opacity-100' : '';
            // Se eliminan las clases de 'starred'

            card.className = `card p-4 fade-in ${lostOpacityClass} shadow-md`;
            card.setAttribute('data-id', sponsorship.id);
            card.setAttribute('data-status', sponsorship.status);

            const statusConfig = {
                'pending': { border: 'border-yellow-500', icon: 'dollar-sign', color: 'text-yellow-600', text: 'PENDIENTE' },
                'paid': { border: 'border-green-500', icon: 'check-circle', color: 'text-green-600', text: 'CAPITAL RECIBIDO' },
                'negotiation': { border: 'border-blue-500', icon: 'clock', color: 'text-blue-600', text: 'EN NEGOCIACI√ìN' },
                'lost': { border: 'border-gray-400', icon: 'slash', color: 'text-gray-400', text: 'PERDIDO' }
            };

            const config = statusConfig[sponsorship.status] || statusConfig['negotiation']; 
            const amount = sponsorship.amount || 0;
            const formattedAmount = `$${amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
            const lastActivityDate = formatDate(sponsorship.lastActivityDate);
            
            let riskClasses = getRiskClasses(sponsorship);
            if (riskClasses) {
                card.classList.add(riskClasses);
            }
            
            let extraInfo = '';
            if (sponsorship.status === 'lost' && sponsorship.lossReason) {
                extraInfo = `<p class="text-xs ${sponsorship.status === 'lost' ? 'text-red-400' : 'text-red-600'} font-semibold mt-2 line-clamp-2">Motivo: ${sponsorship.lossReason}</p>`;
            }
            
            // Icono de Valor Din√°mico
            const valueIcon = getValueIcon(amount);
            
            card.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center space-x-1">
                        <span class="text-xs font-semibold ${sponsorship.status === 'lost' ? 'text-gray-300' : 'text-gray-500'} uppercase tracking-widest">${config.text}</span>
                        ${valueIcon}
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- Bot√≥n de Editar -->
                        <button class="edit-card-btn text-gray-400 hover:text-indigo-600 transition p-1 rounded-full hover:bg-gray-100 ${sponsorship.status === 'lost' ? 'text-gray-400 hover:bg-gray-700' : ''}" data-id="${sponsorship.id}" title="Click para editar.">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <h3 class="text-lg font-bold ${sponsorship.status === 'lost' ? 'text-gray-100' : 'text-gray-800'} mb-1 line-clamp-1">${sponsorship.name}</h3>
                <p class="text-2xl font-extrabold ${config.color} mb-2 flex items-center">
                    <i data-lucide="${config.icon}" class="w-5 h-5 mr-2"></i>
                    ${formattedAmount}
                </p>
                ${sponsorship.notes ? `<p class="text-sm ${sponsorship.status === 'lost' ? 'text-gray-300' : 'text-gray-500'} italic mt-2 line-clamp-2">${sponsorship.notes}</p>` : ''}
                <p class="text-xs ${sponsorship.status === 'lost' ? 'text-gray-400' : 'text-gray-500'} mt-2 font-semibold">√öltima Actividad: <span class="${sponsorship.status === 'lost' ? 'text-gray-200' : 'text-gray-700'}">${lastActivityDate}</span></p>
                ${extraInfo}
            `;
            
            // Aplicar el color de borde de la columna, que puede ser sobrescrito por las clases de riesgo
            card.style.borderColor = config.border.split('-').pop();

            const editButton = card.querySelector('.edit-card-btn');
            editButton.addEventListener('click', (e) => {
                e.stopPropagation(); 
                showEditModal(sponsorship.id);
            });
            
            card.setAttribute('draggable', true);
            card.addEventListener('dragstart', handleDragStart);
            
            return card;
        }

        function calculateHistoricalTotalPaid() {
            return allSponsorships.reduce((sum, s) => {
                if (s.status === 'paid') {
                    return sum + (s.amount || 0);
                }
                return sum;
            }, 0);
        }
        
        // --- FUNCI√ìN DE C√ÅLCULO Y RENDERIZADO DEL FUNNEL ---
        function updateFunnel(totalNegotiation, totalPending, totalPaid) {
            const totalActive = totalNegotiation + totalPending + totalPaid;
            
            const negotiationPercent = totalActive > 0 ? (totalNegotiation / totalActive) * 100 : 0;
            const pendingPercent = totalActive > 0 ? (totalPending / totalActive) * 100 : 0;
            const paidPercent = totalActive > 0 ? (totalPaid / totalActive) * 100 : 0;

            const negotiationBar = document.getElementById('funnel-negotiation');
            const pendingBar = document.getElementById('funnel-pending');
            const paidBar = document.getElementById('funnel-paid');

            negotiationBar.style.width = `${negotiationPercent.toFixed(2)}%`;
            negotiationBar.textContent = negotiationPercent > 5 ? `${negotiationPercent.toFixed(0)}%` : ''; // Mostrar % solo si es > 5%
            
            pendingBar.style.width = `${pendingPercent.toFixed(2)}%`;
            pendingBar.textContent = pendingPercent > 5 ? `${pendingPercent.toFixed(0)}%` : '';

            paidBar.style.width = `${paidPercent.toFixed(2)}%`;
            paidBar.textContent = paidPercent > 5 ? `${paidPercent.toFixed(0)}%` : '';
            
            // Ajustar el texto de la barra si es muy peque√±o para evitar overflow
            if (negotiationPercent < 15) negotiationBar.style.color = '#000'; else negotiationBar.style.color = '#fff';
            if (pendingPercent < 15) pendingBar.style.color = '#000'; else pendingBar.style.color = '#fff';
            if (paidPercent < 15) paidBar.style.color = '#000'; else paidBar.style.color = '#fff';
            
            // Asegurar que si el porcentaje es muy bajo, no se muestre texto para no apilar
            if (negotiationPercent < 3) negotiationBar.textContent = '';
            if (pendingPercent < 3) pendingBar.textContent = '';
            if (paidPercent < 3) paidBar.textContent = '';
        }

        function renderSponsorships() {
            // Limpiar columnas
            ['negotiation', 'pending', 'paid', 'lost'].forEach(status => {
                document.getElementById(`${status}-list`).innerHTML = '';
            });

            let totalNegotiation = 0;
            let totalPending = 0;
            let totalPaid = 0;
            let totalLost = 0; 

            const counts = { negotiation: 0, pending: 0, paid: 0, lost: 0 };
            
            const allStatuses = ['negotiation', 'pending', 'paid', 'lost'];

            allStatuses.forEach(statusKey => {
                // getSortedSponsorships aplica el filtro de fecha para negotiation, pending, paid
                const columnData = getSortedSponsorships(statusKey); 
                const listElement = document.getElementById(`${statusKey}-list`);
                
                columnData.forEach(sponsorship => {
                    const amount = sponsorship.amount || 0;
                    
                    if (statusKey === 'negotiation') {
                        totalNegotiation += amount;
                    } else if (statusKey === 'pending') {
                        totalPending += amount;
                    } else if (statusKey === 'paid') {
                        totalPaid += amount;
                    } else if (statusKey === 'lost') {
                        totalLost += amount;
                    }
                    
                    counts[statusKey]++;
                    const card = createCardElement(sponsorship);
                    listElement.appendChild(card);
                });
            });


            // --- Actualizar UI para el monto total y las tarjetas de resumen ---
            const formatCurrency = (amount) => `$${amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
            
            // Capital Proyectado TOTAL (Filtrado)
            const totalProjected = totalNegotiation + totalPending + totalPaid; 
            
            document.getElementById('capital-negotiation').textContent = formatCurrency(totalNegotiation);
            document.getElementById('capital-pending').textContent = formatCurrency(totalPending);
            document.getElementById('capital-paid').textContent = formatCurrency(totalPaid);
            document.getElementById('total-amount').textContent = formatCurrency(totalProjected);
            
            // Actualizar el Gr√°fico de Embudo
            updateFunnel(totalNegotiation, totalPending, totalPaid);

            // Capital Total Hist√≥rico Recibido (SIN FILTRO - utiliza la funci√≥n que ignora la fecha)
            const historicalPaid = calculateHistoricalTotalPaid();
            document.getElementById('historical-total-paid').textContent = formatCurrency(historicalPaid);
            
            Object.keys(counts).forEach(status => {
                document.getElementById(`${status}-count`).textContent = counts[status];
            });
            
            lucide.createIcons(); 
        }

        // --- LISTENERS DE FORMULARIOS Y MODALES ---

        function setupFormListeners() {
            const addBtn = document.getElementById('add-sponsorship-btn');
            const cancelBtn = document.getElementById('cancel-add-btn');
            const formContainer = document.getElementById('add-form-container');
            const addForm = document.getElementById('add-sponsorship-form');

            addBtn.addEventListener('click', () => {
                formContainer.classList.remove('hidden');
                addBtn.classList.add('hidden');
                document.getElementById('sponsorship-name').focus();
            });

            cancelBtn.addEventListener('click', () => {
                formContainer.classList.add('hidden');
                addBtn.classList.remove('hidden');
                addForm.reset();
            });

            addForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('sponsorship-name').value.trim();
                const amount = document.getElementById('sponsorship-amount').value;
                const notes = document.getElementById('sponsorship-notes').value.trim();

                if (name && amount) {
                    // Llama a la funci√≥n actualizada
                    await addSponsorship(name, amount, notes);
                } else {
                    showConfirmationModal('Datos Incompletos', 'Por favor, completa al menos el nombre y el monto.', () => {});
                }
            });
        }
        
        function setupModalListeners() {
            // Cierre del modal de Edici√≥n
            document.getElementById('edit-modal-close').addEventListener('click', hideEditModal);
            document.getElementById('edit-modal').addEventListener('click', (e) => {
                if (e.target.id === 'edit-modal') hideEditModal();
            });

            // Formulario de Edici√≥n (Guardar Cambios)
            document.getElementById('edit-sponsorship-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-sponsorship-id').value;
                const name = document.getElementById('edit-sponsorship-name').value.trim();
                const amount = document.getElementById('edit-sponsorship-amount').value;
                const notes = document.getElementById('edit-sponsorship-notes').value.trim();
                
                const sponsorship = allSponsorships.find(s => s.id === id);
                let updateData = {
                    name: name,
                    amount: parseFloat(amount),
                    notes: notes
                };
                
                if (sponsorship && sponsorship.status === 'lost') {
                    updateData.lossReason = document.getElementById('edit-loss-reason').value.trim();
                }


                if (name && amount) {
                    // Si se edita la tarjeta, marcamos que se debe actualizar la fecha de actividad.
                    // Si solo se cambia lossReason en un lost, la funci√≥n updateSponsorship lo manejar√°.
                    await updateSponsorship(id, updateData, true); 
                    hideEditModal();
                } else {
                    showConfirmationModal('Datos Incompletos', 'Por favor, completa al menos el nombre y el monto.', () => {});
                }
            });

            // Bot√≥n de Eliminar en el modal de Edici√≥n
            document.getElementById('delete-sponsorship-btn').addEventListener('click', () => {
                const id = document.getElementById('edit-sponsorship-id').value;
                const name = document.getElementById('edit-sponsorship-name').value;
                
                showConfirmationModal(
                    'Confirmar Eliminaci√≥n',
                    `¬øEst√°s seguro de que quieres eliminar permanentemente el patrocinio de <strong>${name}</strong>? Esta acci√≥n no se puede deshacer.`,
                    () => deleteSponsorship(id)
                );
            });
        }

        function showEditModal(id) {
            const sponsorship = allSponsorships.find(s => s.id === id);
            if (!sponsorship) return;

            document.getElementById('edit-sponsorship-id').value = id;
            document.getElementById('edit-sponsorship-name').value = sponsorship.name;
            document.getElementById('edit-sponsorship-amount').value = sponsorship.amount || 0;
            document.getElementById('edit-sponsorship-notes').value = sponsorship.notes || '';
            
            // Mostrar la fecha de √∫ltima actividad
            const lastActivityDisplay = document.getElementById('last-activity-display');
            lastActivityDisplay.textContent = `√öltima Actividad: ${formatDate(sponsorship.lastActivityDate)}`;
            
            const lossReasonContainer = document.getElementById('edit-loss-reason-container');
            const editLossReason = document.getElementById('edit-loss-reason');

            if (sponsorship.status === 'lost') {
                lossReasonContainer.classList.remove('hidden');
                editLossReason.value = sponsorship.lossReason || '';
            } else {
                lossReasonContainer.classList.add('hidden');
                editLossReason.value = '';
            }
            
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-modal').classList.add('flex');
            document.getElementById('edit-sponsorship-name').focus();
            lucide.createIcons();
        }

        function hideEditModal() {
            document.getElementById('edit-modal').classList.remove('flex');
            document.getElementById('edit-modal').classList.add('hidden');
        }


        // --- DRAG & DROP ---
        function handleDragStart(event) {
            draggedId = event.target.getAttribute('data-id');
            event.dataTransfer.setData('text/plain', draggedId);
            event.target.classList.add('opacity-50');
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(event, newStatus) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const cardElement = document.querySelector(`[data-id="${draggedId}"]`);
            if (cardElement) cardElement.classList.remove('opacity-50');

            const idToUpdate = draggedId;
            if (!idToUpdate) return;

            const currentStatus = cardElement.getAttribute('data-status');
            if (currentStatus === newStatus) {
                draggedId = null; 
                return;
            }

            const sponsorship = allSponsorships.find(s => s.id === idToUpdate);
            if (!sponsorship) return;

            if (newStatus === 'lost') {
                showConfirmationModal(
                    'Confirmar Oportunidad Perdida',
                    `Est√°s a punto de mover <strong>${sponsorship.name}</strong> a la columna PERDIDO. Por favor, especifica el motivo para el an√°lisis futuro:`,
                    (lossReason) => updateSponsorshipStatus(idToUpdate, newStatus, lossReason), 
                    true 
                );
            } else {
                 showConfirmationModal(
                    'Confirmar Cambio',
                    `¬øMover <strong>${sponsorship.name}</strong> a <strong>${getStatusName(newStatus)}</strong>?`,
                    () => updateSponsorshipStatus(idToUpdate, newStatus) 
                );
            }
            
            draggedId = null; 
        }

        function getStatusName(status) {
            const names = {
                'negotiation': 'Propuesta y Negociaci√≥n',
                'pending': 'Acuerdos en Cierre', 
                'paid': '√âxito y Cierre de Capital',
                'lost': 'Oportunidades Perdidas'
            };
            return names[status];
        }

        // --- MODAL DE CONFIRMACI√ìN GENERAL (CORREGIDO Y AJUSTADO) ---
        function showConfirmationModal(title, message, onConfirm, showLossReason = false) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message;
            const modal = document.getElementById('action-modal');
            const lossReasonField = document.getElementById('loss-reason-field');
            const lossReasonInput = document.getElementById('loss-reason');
            const confirmBtn = document.getElementById('modal-confirm');
            
            lossReasonInput.value = ''; 

            if (showLossReason) {
                lossReasonField.classList.remove('hidden');
                confirmBtn.textContent = 'Confirmar P√©rdida';
                confirmBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                lossReasonField.classList.add('hidden');
                confirmBtn.textContent = 'Confirmar';
                confirmBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                confirmBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            confirmBtn.onclick = () => {
                modal.classList.add('hidden');
                if (onConfirm) {
                    if (showLossReason) {
                        onConfirm(lossReasonInput.value.trim());
                    } else {
                        onConfirm(); 
                    }
                }
            };

            document.getElementById('modal-cancel').onclick = () => {
                modal.classList.add('hidden');
            };
        }

        // Funciones globales para HTML
        window.handleDragOver = handleDragOver;
        window.handleDragLeave = handleDragLeave;
        window.handleDrop = handleDrop;
        window.sortColumn = sortColumn;
        window.applyFilter = applyFilter; 

        // Inicializar la aplicaci√≥n al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</body>
</html>
