<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Patrocinios - Jorge Dos Santos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; min-height: 100vh; }
        /* Aumentar ancho m√°ximo de columna para dar espacio a 4 columnas en pantallas grandes */
        .kanban-column { min-width: 280px; max-width: 300px; background-color: #ffffff; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .card { cursor: pointer; transition: transform 0.1s ease, box-shadow 0.1s ease; }
        .card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); }
        .card:active { transform: scale(1.02); }
        .drag-over { background-color: #e0e7ff; border-color: #3b82f6; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Clases de Riesgo */
        .risk-orange { border-color: #f97316 !important; background-color: #fff7ed !important; }
        .risk-red { border-color: #ef4444 !important; background-color: #fee2e2 !important; }
    </style>
</head>
<body class="p-4 md:p-8">
    <header class="mb-8 p-6 bg-white rounded-2xl shadow-2xl border-t-4 border-indigo-600">
        <div class="flex items-start justify-between">
            <div>
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-2 flex items-center">
                    <i data-lucide="car" class="w-7 h-7 mr-3 text-indigo-700"></i>
                    Dashboard de Patrocinios - Jorge Dos Santos
                </h1>
                <p class="text-lg text-gray-600" id="sync-status">Conectando a la base de datos...</p>
            </div>
            <span id="connection-status" class="text-sm bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full font-semibold ml-4 shadow-inner">
                Conectando...
            </span>
        </div>
        
        <!-- Tarjetas de Resumen de Capital (Opci√≥n 3) -->
        <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
            
            <!-- Capital en Negociaci√≥n (Filtrado) -->
            <div class="p-5 bg-blue-100 rounded-xl shadow-md border-b-4 border-blue-500">
                <p class="text-sm font-semibold text-blue-700 uppercase mb-1">En Negociaci√≥n (Filtro)</p>
                <div class="flex items-center justify-between">
                    <span id="capital-negotiation" class="text-2xl font-extrabold text-blue-800">$0.00</span>
                    <i data-lucide="bar-chart-2" class="w-6 h-6 text-blue-500"></i>
                </div>
            </div>

            <!-- Capital Pendiente de Pago (Filtrado) -->
            <div class="p-5 bg-yellow-100 rounded-xl shadow-md border-b-4 border-yellow-500">
                <p class="text-sm font-semibold text-yellow-700 uppercase mb-1">Pendiente de Pago (Filtro)</p>
                <div class="flex items-center justify-between">
                    <span id="capital-pending" class="text-2xl font-extrabold text-yellow-800">$0.00</span>
                    <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-500"></i>
                </div>
            </div>

            <!-- Capital Recibido (Pagado) (Filtrado) -->
            <div class="p-5 bg-green-100 rounded-xl shadow-md border-b-4 border-green-500">
                <p class="text-sm font-semibold text-green-700 uppercase mb-1">Capital Recibido (Filtro)</p>
                <div class="flex items-center justify-between">
                    <span id="capital-paid" class="text-2xl font-extrabold text-green-800">$0.00</span>
                    <i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>
                </div>
            </div>
            
            <!-- Capital Proyectado TOTAL (Negociaci√≥n + Pendiente + Pagado) (Filtrado) -->
            <div class="p-5 bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-xl shadow-lg border-b-4 border-indigo-300">
                <p class="text-sm font-semibold text-indigo-200 uppercase mb-1">Capital Proyectado Total (Filtro)</p>
                <div class="flex items-center justify-between">
                    <span id="total-amount" class="text-2xl font-extrabold text-white">$0.00</span>
                    <i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
                </div>
            </div>

            <!-- Capital Total Hist√≥rico Recibido (Pagado) (SIN FILTRO) -->
            <div class="p-5 bg-purple-100 rounded-xl shadow-md border-b-4 border-purple-600">
                <p class="text-sm font-semibold text-purple-700 uppercase mb-1">Total Generado Hist√≥rico (PAGADO)</p>
                <div class="flex items-center justify-between">
                    <span id="historical-total-paid" class="text-2xl font-extrabold text-purple-800">$0.00</span>
                    <i data-lucide="wallet" class="w-6 h-6 text-purple-600"></i>
                </div>
            </div>

        </div>
        
        <!-- Controles de Filtro -->
        <div class="mt-6 space-y-4 md:space-y-0 md:flex md:justify-between md:items-center">
            
            <!-- Filtros por Fecha -->
            <div class="p-4 md:p-5 bg-gray-50 rounded-xl shadow-inner border border-gray-200 flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4 items-stretch md:items-center w-full md:w-auto">
                <label class="font-bold text-gray-700 text-lg flex items-center">
                    <i data-lucide="calendar" class="w-5 h-5 mr-2 text-indigo-500"></i>
                    Filtrar por Fecha:
                </label>
                <select id="filter-year" class="p-2 border border-gray-300 rounded-lg text-base bg-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500 w-full md:w-auto" onchange="applyFilter()">
                    <option value="all">Todo el Historial</option>
                </select>
                <select id="filter-month" class="p-2 border border-gray-300 rounded-lg text-base bg-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500 w-full md:w-auto" onchange="applyFilter()">
                    <option value="all">Todos los Meses</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
            </div>
        </div>
        
    </header>

    <main class="flex flex-row overflow-x-auto gap-6 justify-center">
        <!-- Columna NEGOCIACI√ìN -->
        <div id="negotiation" class="kanban-column rounded-xl p-4 flex flex-col h-full" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'negotiation')" ondragleave="handleDragLeave(event)">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2 flex items-center justify-between">
                <div class="flex items-center">
                    <i data-lucide="clock" class="w-5 h-5 mr-2 text-blue-500"></i>
                    Fase I: Propuesta y Negociaci√≥n
                </div>
                <span class="ml-2 text-sm bg-blue-100 text-blue-700 px-2 py-1 rounded-full" id="negotiation-count">0</span>
            </h2>
            <button id="add-sponsorship-btn" class="mb-4 w-full flex items-center justify-center px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">
                <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                A√±adir Nueva Oportunidad
            </button>
            <div id="add-form-container" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg shadow-inner hidden">
                <form id="add-sponsorship-form">
                    <input type="text" id="sponsorship-name" placeholder="Nombre de la Marca" required class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="number" id="sponsorship-amount" placeholder="Monto (ej: 1500)" required class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" min="0">
                    <textarea id="sponsorship-notes" placeholder="Notas clave" rows="2" class="w-full p-2 mb-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    <div class="flex justify-between space-x-2">
                        <button type="submit" class="flex-1 px-3 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition">Guardar</button>
                        <button type="button" id="cancel-add-btn" class="px-3 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition flex items-center">
                            <i data-lucide="x-circle" class="w-4 h-4 mr-1"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
            <!-- Selector de Ordenamiento -->
            <div class="mb-4 flex items-center">
                <i data-lucide="arrow-up-down" class="w-4 h-4 mr-2 text-gray-500"></i>
                <select id="sort-negotiation" class="p-2 border border-gray-300 rounded-lg text-sm w-full bg-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500" onchange="sortColumn('negotiation', this.value)">
                    <option value="default">Ordenar por...</option>
                    <option value="amount_desc">Monto Mayor</option>
                    <option value="amount_asc">Monto Menor</option>
                    <option value="name_asc">Nombre A-Z</option>
                    <option value="name_desc">Nombre Z-A</option>
                </select>
            </div>
            <div id="negotiation-list" class="space-y-4 flex-grow"></div>
        </div>

        <!-- Columna PENDIENTE -->
        <div id="pending" class="kanban-column rounded-xl p-4 flex flex-col h-full" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'pending')" ondragleave="handleDragLeave(event)">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2 flex items-center justify-between">
                <div class="flex items-center">
                    <i data-lucide="dollar-sign" class="w-5 h-5 mr-2 text-yellow-500"></i>
                    Fase II: Acuerdos en Cierre
                </div>
                <span class="ml-2 text-sm bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full" id="pending-count">0</span>
            </h2>
            <!-- Selector de Ordenamiento -->
            <div class="mb-4 flex items-center">
                <i data-lucide="arrow-up-down" class="w-4 h-4 mr-2 text-gray-500"></i>
                <select id="sort-pending" class="p-2 border border-gray-300 rounded-lg text-sm w-full bg-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500" onchange="sortColumn('pending', this.value)">
                    <option value="default">Ordenar por...</option>
                    <option value="amount_desc">Monto Mayor</option>
                    <option value="amount_asc">Monto Menor</option>
                    <option value="name_asc">Nombre A-Z</option>
                    <option value="name_desc">Nombre Z-A</option>
                </select>
            </div>
            <div id="pending-list" class="space-y-4 flex-grow"></div>
        </div>

        <!-- Columna PAGADO -->
        <div id="paid" class="kanban-column rounded-xl p-4 flex flex-col h-full" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'paid')" ondragleave="handleDragLeave(event)">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2 flex items-center justify-between">
                <div class="flex items-center">
                    <i data-lucide="check-circle" class="w-5 h-5 mr-2 text-green-500"></i>
                    Fase III: √âxito y Cierre de Capital
                </div>
                <span class="ml-2 text-sm bg-green-100 text-green-700 px-2 py-1 rounded-full" id="paid-count">0</span>
            </h2>
            <!-- Selector de Ordenamiento -->
            <div class="mb-4 flex items-center">
                <i data-lucide="arrow-up-down" class="w-4 h-4 mr-2 text-gray-500"></i>
                <select id="sort-paid" class="p-2 border border-gray-300 rounded-lg text-sm w-full bg-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500" onchange="sortColumn('paid', this.value)">
                    <option value="default">Ordenar por...</option>
                    <option value="amount_desc">Monto Mayor</option>
                    <option value="amount_asc">Monto Menor</option>
                    <option value="name_asc">Nombre A-Z</option>
                    <option value="name_desc">Nombre Z-A</option>
                </select>
            </div>
            <div id="paid-list" class="space-y-4 flex-grow"></div>
        </div>

        <!-- Columna PERDIDO (Nueva columna para medir el fracaso) -->
        <div id="lost" class="kanban-column rounded-xl p-4 flex flex-col h-full" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'lost')" ondragleave="handleDragLeave(event)">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2 flex items-center justify-between">
                <div class="flex items-center">
                    <i data-lucide="x-circle" class="w-5 h-5 mr-2 text-red-500"></i>
                    Oportunidades Perdidas
                </div>
                <span class="ml-2 text-sm bg-red-100 text-red-700 px-2 py-1 rounded-full" id="lost-count">0</span>
            </h2>
            <!-- Selector de Ordenamiento -->
            <div class="mb-4 flex items-center">
                <i data-lucide="arrow-up-down" class="w-4 h-4 mr-2 text-gray-500"></i>
                <select id="sort-lost" class="p-2 border border-gray-300 rounded-lg text-sm w-full bg-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500" onchange="sortColumn('lost', this.value)">
                    <option value="default">Ordenar por...</option>
                    <option value="amount_desc">Monto Mayor</option>
                    <option value="amount_asc">Monto Menor</option>
                    <option value="name_asc">Nombre A-Z</option>
                    <option value="name_desc">Nombre Z-A</option>
                </select>
            </div>
            <div id="lost-list" class="space-y-4 flex-grow"></div>
        </div>
    </main>

    <!-- Modal de ACCI√ìN/CONFIRMACI√ìN (para arrastrar y eliminar) -->
    <div id="action-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold mb-4 text-gray-800">Confirmar Acci√≥n</h3>
            <p id="modal-message" class="mb-6 text-gray-600"></p>
            <!-- Campo opcional para Motivo de P√©rdida -->
            <div id="loss-reason-field" class="hidden mb-6">
                <label for="loss-reason" class="block text-sm font-medium text-gray-700 mb-1">Motivo de la P√©rdida</label>
                <textarea id="loss-reason" rows="2" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Ej: Precio de la competencia, Presupuesto agotado"></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                <button id="modal-confirm" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de EDICI√ìN (para ver/modificar detalles) -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2 flex items-center justify-between">
                Detalles del Patrocinio
                <button id="edit-modal-close" class="text-gray-400 hover:text-gray-600 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </h3>
            <form id="edit-sponsorship-form">
                <input type="hidden" id="edit-sponsorship-id">
                
                <div class="mb-4">
                    <label for="edit-sponsorship-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Marca</label>
                    <input type="text" id="edit-sponsorship-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <div class="mb-4">
                    <label for="edit-sponsorship-amount" class="block text-sm font-medium text-gray-700 mb-1">Monto Proyectado ($)</label>
                    <input type="number" id="edit-sponsorship-amount" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" min="0">
                </div>
                
                <div class="mb-6">
                    <label for="edit-sponsorship-notes" class="block text-sm font-medium text-gray-700 mb-1">Notas Clave</label>
                    <textarea id="edit-sponsorship-notes" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                
                <!-- Campo de Motivo de P√©rdida (solo visible si status es 'lost') -->
                <div id="edit-loss-reason-container" class="mb-6 hidden">
                    <label for="edit-loss-reason" class="block text-sm font-medium text-gray-700 mb-1">Motivo por el que se Perdi√≥</label>
                    <textarea id="edit-loss-reason" rows="2" class="w-full p-3 border border-gray-300 rounded-lg bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
                </div>

                <div class="flex justify-between items-center border-t pt-4">
                    <button type="button" id="delete-sponsorship-btn" class="flex items-center px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition shadow-md">
                        <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i>
                        Eliminar Patrocinio
                    </button>
                    <button type="submit" class="flex items-center px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition shadow-lg">
                        <i data-lucide="save" class="w-5 h-5 mr-2"></i>
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- SCRIPTS DE FIREBASE CON LAS LIBRER√çAS COMPAT -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // CONFIGURACI√ìN DE FIREBASE - Mantenida como est√° en tu repositorio
        const firebaseConfig = {
            apiKey: "AIzaSyA1UPMYdUxOPfBpExXsdWJO_AUjaqW4x5U",
            authDomain: "tablero-jorge.firebaseapp.com",
            projectId: "tablero-jorge",
            storageBucket: "tablero-jorge.firebasestorage.app",
            messagingSenderId: "385852863891",
            appId: "1:385852863891:web:48a6fbaaa19fb7cbbd588"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        lucide.createIcons();

        let allSponsorships = []; // Almacena todos los patrocinios (sin filtrar)
        let isOnline = false;
        let columnSorts = { negotiation: 'default', pending: 'default', paid: 'default', lost: 'default' }; // Estado de ordenamiento
        let draggedId = null; // ID de la tarjeta que se est√° arrastrando

        // --- INICIALIZACI√ìN Y CONEXI√ìN ---
        async function initFirebase() {
            try {
                updateConnectionStatus('connecting');
                
                populateYearFilter();

                // Usamos signInAnonymously como fallback seguro para pruebas
                await auth.signInAnonymously(); 

                setupRealtimeListener();
                setupFormListeners();
                setupModalListeners();
                
            } catch (error) {
                console.error("‚ùå Error Firebase:", error);
                updateConnectionStatus('error');
                showConfirmationModal('Error de Conexi√≥n', 
                    `No se pudo conectar a Firebase. Error: ${error.message}`, 
                    () => {}
                );
            }
        }

        function updateConnectionStatus(status) {
            const element = document.getElementById('connection-status');
            const syncText = document.getElementById('sync-status');
            
            element.classList.remove('bg-green-100', 'bg-red-100', 'bg-yellow-100', 'text-green-700', 'text-red-700', 'text-yellow-700');
            
            if (status === 'connected') {
                element.textContent = 'Conectado ‚úì';
                element.classList.add('bg-green-100', 'text-green-700');
                syncText.textContent = 'Sincronizado en tiempo real';
                syncText.classList.remove('text-gray-600', 'text-red-600');
                syncText.classList.add('text-green-600');
                isOnline = true;
            } else if (status === 'error') {
                element.textContent = 'Error de Conexi√≥n ‚úó';
                element.classList.add('bg-red-100', 'text-red-700');
                syncText.textContent = 'Modo local (sin sincronizaci√≥n)';
                syncText.classList.remove('text-gray-600', 'text-green-600');
                syncText.classList.add('text-red-600');
                isOnline = false;
                // En caso de error, mostrar datos de ejemplo para que la UI no quede vac√≠a
                showExampleData();
            } else {
                element.textContent = 'Conectando...';
                element.classList.add('bg-yellow-100', 'text-yellow-700');
                syncText.textContent = 'Conectando a la base de datos...';
                syncText.classList.remove('text-green-600', 'text-red-600');
                syncText.classList.add('text-gray-600');
            }
        }

        function setupRealtimeListener() {
            db.collection('sponsorships').onSnapshot((snapshot) => {
                allSponsorships = [];
                const years = new Set();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const sponsorship = {
                        id: doc.id,
                        ...data,
                        // Convertir el timestamp de Firebase a objeto Date para facilitar el filtrado
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date(), 
                    };
                    allSponsorships.push(sponsorship);
                    if (sponsorship.createdAt instanceof Date) {
                        years.add(sponsorship.createdAt.getFullYear());
                    }
                });
                
                // Asegurar que el filtro de a√±os se actualice din√°micamente
                populateYearFilter(Array.from(years));
                applyFilter(); // Aplicar el filtro despu√©s de cargar los datos
                updateConnectionStatus('connected');
                
            }, (error) => {
                console.error("‚ùå Error en listener:", error);
                updateConnectionStatus('error');
            });
        }
        
        // Funci√≥n para poblar din√°micamente el selector de a√±os
        function populateYearFilter(yearList = []) {
            const yearSelect = document.getElementById('filter-year');
            const currentSelectedYear = yearSelect.value;
            
            const optionsToKeep = yearSelect.querySelector('option[value="all"]').outerHTML;
            yearSelect.innerHTML = optionsToKeep;

            const sortedYears = Array.from(new Set(yearList)).sort((a, b) => b - a);

            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            
            // Restaurar la selecci√≥n anterior si existe
            if (currentSelectedYear && yearSelect.querySelector(`option[value="${currentSelectedYear}"]`)) {
                yearSelect.value = currentSelectedYear;
            }
        }

        function showExampleData() {
            const now = new Date();
            const eightDaysAgo = new Date();
            eightDaysAgo.setDate(now.getDate() - 8);
            
            const exampleData = [
                { id: '1', name: 'Moss (Riesgo Naranja)', amount: 2000, status: 'negotiation', notes: 'No ha respondido en 8 d√≠as.', createdAt: eightDaysAgo },
                { id: '2', name: 'Puma (Negociaci√≥n Activa)', amount: 900, status: 'negotiation', notes: 'Revisi√≥n final de contrato.', createdAt: now },
                { id: '3', name: 'Gp (Pagado)', amount: 1000, status: 'paid', notes: 'Pagado en cash. Cerrado.', createdAt: now },
                { id: '4', name: 'Arcoweld (Perdido)', amount: 700, status: 'lost', notes: 'El cliente se fue con la competencia.', lossReason: 'Precio de la competencia' , createdAt: eightDaysAgo },
                { id: '5', name: 'Mi casino (Riesgo Rojo)', amount: 450, status: 'negotiation', notes: 'Sin respuesta en 11 d√≠as.', createdAt: new Date(now.getTime() - 11 * 24 * 60 * 60 * 1000) },
                { id: '6', name: 'Solverapp (Pendiente)', amount: 550, status: 'pending', notes: 'Pendiente de transferencia.', createdAt: eightDaysAgo },
                { id: '7', name: 'Zeta Corp', amount: 1200, status: 'pending', notes: 'Firma de acuerdo pendiente', createdAt: now }
            ];
            
            allSponsorships = exampleData;
            applyFilter();
        }

        // --- L√ìGICA DE FILTRADO ---

        function applyFilter() {
            // Aqu√≠ solo se llama a renderSponsorships, el filtrado se hace dentro de getSortedSponsorships
            renderSponsorships(); 
        }


        // --- CRUD EN FIREBASE ---
        async function updateSponsorship(id, data) {
            // **FIX PARA ERROR: Validar el ID antes de usar doc()**
            if (!id || typeof id !== 'string' || id.trim() === '') {
                console.error("üö´ Error: ID de patrocinio inv√°lido o vac√≠o. No se puede actualizar.");
                showConfirmationModal('Error de Datos', 'ID de patrocinio no encontrado. No se puede realizar la actualizaci√≥n.', () => {});
                return;
            }

            // **CORRECCI√ìN 1: La verificaci√≥n de la conexi√≥n est√° aqu√≠ para el CRUD**
            if (!isOnline) {
                // Usamos el modal de confirmaci√≥n como modal de alerta/error
                showConfirmationModal('Sin Conexi√≥n', 'No hay conexi√≥n a Internet. Los cambios no se guardar√°n.', () => {});
                return;
            }
            
            try {
                await db.collection('sponsorships').doc(id).update({
                    ...data,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log(`‚úÖ Actualizado: ${id}`);
            } catch (error) {
                console.error("Error actualizando:", error);
                showConfirmationModal('Error', `No se pudo actualizar el patrocinio. Error: ${error.message}`, () => {});
            }
        }

        async function updateSponsorshipStatus(id, newStatus, lossReason = null) {
            const updateData = { status: newStatus };
            if (newStatus === 'lost' && lossReason) {
                updateData.lossReason = lossReason;
            } else if (newStatus !== 'lost') {
                // Asegurar que si regresa a una columna de capital, se borre el motivo de p√©rdida
                updateData.lossReason = firebase.firestore.FieldValue.delete();
            }
            // Llama a la funci√≥n que tiene la verificaci√≥n de conexi√≥n
            await updateSponsorship(id, updateData);
        }
        
        async function deleteSponsorship(id) {
            // **FIX PARA ERROR: Validar el ID antes de usar doc()**
            if (!id || typeof id !== 'string' || id.trim() === '') {
                console.error("üö´ Error: ID de patrocinio inv√°lido o vac√≠o. No se puede eliminar.");
                showConfirmationModal('Error de Datos', 'ID de patrocinio no encontrado. No se puede realizar la eliminaci√≥n.', () => {});
                return;
            }
            
            if (!isOnline) {
                showConfirmationModal('Sin Conexi√≥n', 'No hay conexi√≥n a Internet. No se puede eliminar.', () => {});
                return;
            }

            try {
                await db.collection('sponsorships').doc(id).delete();
                console.log(`üóëÔ∏è Eliminado: ${id}`);
                hideEditModal();
            } catch (error) {
                console.error("Error eliminando:", error);
                showConfirmationModal('Error', 'No se pudo eliminar. Revisa la conexi√≥n.', () => {});
            }
        }

        async function addSponsorship(name, amount, notes) {
            if (!isOnline) {
                showConfirmationModal('Sin Conexi√≥n', 'No hay conexi√≥n. No se puede agregar nuevo patrocinio.', () => {});
                return false;
            }
            
            try {
                await db.collection('sponsorships').add({
                    name: name,
                    amount: parseFloat(amount),
                    notes: notes,
                    status: 'negotiation',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return true;
            } catch (error) {
                console.error("Error agregando:", error);
                showConfirmationModal('Error', 'No se pudo guardar. Revisa la conexi√≥n.', () => {});
                return false;
            }
        }

        // --- RENDERIZADO Y L√ìGICA DE COLUMNAS ---
        function sortColumn(status, sortBy) {
            columnSorts[status] = sortBy;
            renderSponsorships();
        }
        
        // Aplica filtros y ordenamiento
        function getSortedSponsorships(status) {
            const selectedYear = document.getElementById('filter-year').value;
            const selectedMonth = document.getElementById('filter-month').value;
            
            let columnSponsorships = allSponsorships.filter(s => s.status === status);

            // Filtrado por fecha: SOLO aplica a columnas de Capital (negotiation, pending, paid)
            if (['negotiation', 'pending', 'paid'].includes(status)) {
                 columnSponsorships = columnSponsorships.filter(sponsorship => {
                    const date = sponsorship.createdAt;
                    if (!date) return true; // Incluir si no tiene fecha

                    const isYearMatch = selectedYear === 'all' || date.getFullYear().toString() === selectedYear;
                    const isMonthMatch = selectedMonth === 'all' || (date.getMonth() + 1).toString() === selectedMonth;

                    return isYearMatch && isMonthMatch;
                });
            }

            const sortBy = columnSorts[status];

            switch (sortBy) {
                case 'amount_desc':
                    columnSponsorships.sort((a, b) => (b.amount || 0) - (a.amount || 0));
                    break;
                case 'amount_asc':
                    columnSponsorships.sort((a, b) => (a.amount || 0) - (b.amount || 0));
                    break;
                case 'name_asc':
                    columnSponsorships.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'name_desc':
                    columnSponsorships.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'default':
                default:
                    // Ordenar por fecha m√°s reciente por defecto
                    columnSponsorships.sort((a, b) => (b.createdAt?.getTime() || 0) - (a.createdAt?.getTime() || 0));
                    break;
            }
            return columnSponsorships;
        }

        function formatDate(date) {
            if (!date || !(date instanceof Date)) return 'N/A';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // --- FUNCI√ìN CENTRAL DE ALERTAS VISUALES ---
        function getRiskClasses(sponsorship) {
            if (sponsorship.status !== 'negotiation') {
                return '';
            }

            const now = new Date();
            const created = sponsorship.createdAt;
            
            if (!created || !(created instanceof Date)) return '';
            
            // Diferencia en milisegundos
            const diffTime = Math.abs(now.getTime() - created.getTime());
            // Diferencia en d√≠as
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            if (diffDays > 10) {
                return 'risk-red'; // M√°s de 10 d√≠as: ROJO (Alto Riesgo)
            } else if (diffDays > 7) {
                return 'risk-orange'; // M√°s de 7 d√≠as: NARANJA (Alerta)
            }
            return ''; // Retorna cadena vac√≠a si no hay riesgo
        }

        function createCardElement(sponsorship) {
            const card = document.createElement('div');
            card.className = 'card bg-white p-4 rounded-lg shadow-md border-t-4 mb-4 fade-in';
            card.setAttribute('data-id', sponsorship.id);
            card.setAttribute('data-status', sponsorship.status);

            const statusConfig = {
                'pending': { border: 'border-yellow-500', icon: 'dollar-sign', color: 'text-yellow-500', text: 'PENDIENTE' },
                'paid': { border: 'border-green-500', icon: 'check-circle', color: 'text-green-500', text: 'CAPITAL RECIBIDO' },
                'negotiation': { border: 'border-blue-500', icon: 'clock', color: 'text-blue-500', text: 'EN NEGOCIACI√ìN' },
                'lost': { border: 'border-gray-400', icon: 'slash', color: 'text-gray-500', text: 'PERDIDO' }
            };

            const config = statusConfig[sponsorship.status] || statusConfig['negotiation']; 
            const formattedAmount = `$${(sponsorship.amount || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
            const creationDate = formatDate(sponsorship.createdAt);
            
            // Aplicar las clases de riesgo para la fase de Negociaci√≥n
            let riskClasses = '';
            if (sponsorship.status === 'negotiation') {
                riskClasses = getRiskClasses(sponsorship);
                // FIX: Solo a√±adir la clase si no es una cadena vac√≠a
                if (riskClasses) {
                    card.classList.add(riskClasses);
                }
            }
            
            let extraInfo = '';
            if (sponsorship.status === 'lost' && sponsorship.lossReason) {
                extraInfo = `<p class="text-xs text-red-600 font-semibold mt-1">Motivo: ${sponsorship.lossReason}</p>`;
            }

            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <span class="text-xs font-semibold text-gray-500 uppercase tracking-widest">${config.text}</span>
                        <span class="text-xs font-medium text-gray-400">| Creado: ${creationDate}</span>
                    </div>
                    <button class="edit-card-btn text-gray-400 hover:text-indigo-600 transition p-1 rounded-full hover:bg-gray-100" data-id="${sponsorship.id}" title="Click para editar.">
                        <i data-lucide="pencil" class="w-4 h-4"></i>
                    </button>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-1">${sponsorship.name}</h3>
                <p class="text-2xl font-extrabold ${config.color} mb-2 flex items-center">
                    <i data-lucide="${config.icon}" class="w-5 h-5 mr-2"></i>
                    ${formattedAmount}
                </p>
                ${sponsorship.notes ? `<p class="text-sm text-gray-500 italic mt-2 line-clamp-2">${sponsorship.notes}</p>` : ''}
                ${extraInfo}
            `;
            
            // A√±adir la clase de borde base (puede ser sobrescrita por las clases de riesgo)
            card.classList.add(config.border);
            
            const editButton = card.querySelector('.edit-card-btn');
            editButton.addEventListener('click', (e) => {
                e.stopPropagation(); 
                showEditModal(sponsorship.id);
            });
            
            card.setAttribute('draggable', true);
            card.addEventListener('dragstart', handleDragStart);
            
            return card;
        }

        // Funci√≥n para calcular el total pagado de todo el historial (sin filtros)
        function calculateHistoricalTotalPaid() {
            return allSponsorships.reduce((sum, s) => {
                if (s.status === 'paid') {
                    return sum + (s.amount || 0);
                }
                return sum;
            }, 0);
        }

        function renderSponsorships() {
            // Limpiar columnas
            ['negotiation', 'pending', 'paid', 'lost'].forEach(status => {
                document.getElementById(`${status}-list`).innerHTML = '';
            });

            let totalNegotiation = 0;
            let totalPending = 0;
            let totalPaid = 0;
            let totalLost = 0; // Sumar para contador visual, pero NO para "Total Proyectado"

            const counts = { negotiation: 0, pending: 0, paid: 0, lost: 0 };
            
            const allStatuses = ['negotiation', 'pending', 'paid', 'lost'];

            allStatuses.forEach(statusKey => {
                const columnData = getSortedSponsorships(statusKey);
                const listElement = document.getElementById(`${statusKey}-list`);
                
                columnData.forEach(sponsorship => {
                    const amount = sponsorship.amount || 0;
                    
                    // Sumar montos para las tarjetas de resumen FILTRADAS
                    if (statusKey === 'negotiation') {
                        totalNegotiation += amount;
                    } else if (statusKey === 'pending') {
                        totalPending += amount;
                    } else if (statusKey === 'paid') {
                        totalPaid += amount;
                    } else if (statusKey === 'lost') {
                        totalLost += amount;
                    }
                    
                    counts[statusKey]++;
                    const card = createCardElement(sponsorship);
                    listElement.appendChild(card);
                });
            });


            // --- Actualizar UI para el monto total y las tarjetas de resumen ---
            const formatCurrency = (amount) => `$${amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
            
            // 1. Totales Filtrados
            // El Total Proyectado SOLO suma Capital (Negociaci√≥n, Pendiente, Pagado)
            const totalProjected = totalNegotiation + totalPending + totalPaid; 
            
            document.getElementById('capital-negotiation').textContent = formatCurrency(totalNegotiation);
            document.getElementById('capital-pending').textContent = formatCurrency(totalPending);
            document.getElementById('capital-paid').textContent = formatCurrency(totalPaid);
            document.getElementById('total-amount').textContent = formatCurrency(totalProjected);

            // 2. Total Hist√≥rico Recibido (NUEVA TARJETA)
            const historicalPaid = calculateHistoricalTotalPaid();
            document.getElementById('historical-total-paid').textContent = formatCurrency(historicalPaid);
            
            // Actualizar UI para los contadores de las columnas
            Object.keys(counts).forEach(status => {
                document.getElementById(`${status}-count`).textContent = counts[status];
            });
            
            lucide.createIcons(); 
        }

        // --- LISTENERS DE FORMULARIOS Y MODALES ---

        function setupFormListeners() {
            const addBtn = document.getElementById('add-sponsorship-btn');
            const cancelBtn = document.getElementById('cancel-add-btn');
            const formContainer = document.getElementById('add-form-container');
            const addForm = document.getElementById('add-sponsorship-form');

            addBtn.addEventListener('click', () => {
                formContainer.classList.remove('hidden');
                addBtn.classList.add('hidden');
                document.getElementById('sponsorship-name').focus();
            });

            cancelBtn.addEventListener('click', () => {
                formContainer.classList.add('hidden');
                addBtn.classList.remove('hidden');
                addForm.reset();
            });

            addForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('sponsorship-name').value.trim();
                const amount = document.getElementById('sponsorship-amount').value;
                const notes = document.getElementById('sponsorship-notes').value.trim();

                if (name && amount) {
                    const success = await addSponsorship(name, amount, notes);
                    if (success) {
                        addForm.reset();
                        formContainer.classList.add('hidden');
                        addBtn.classList.remove('hidden');
                    }
                } else {
                    showConfirmationModal('Datos Incompletos', 'Por favor, completa al menos el nombre y el monto.', () => {});
                }
            });
        }
        
        function setupModalListeners() {
            // Cierre del modal de Edici√≥n
            document.getElementById('edit-modal-close').addEventListener('click', hideEditModal);
            document.getElementById('edit-modal').addEventListener('click', (e) => {
                if (e.target.id === 'edit-modal') hideEditModal();
            });

            // Formulario de Edici√≥n (Guardar Cambios)
            document.getElementById('edit-sponsorship-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-sponsorship-id').value;
                const name = document.getElementById('edit-sponsorship-name').value.trim();
                const amount = document.getElementById('edit-sponsorship-amount').value;
                const notes = document.getElementById('edit-sponsorship-notes').value.trim();
                
                // Obtener el motivo de p√©rdida solo si es relevante (la tarjeta est√° en 'lost')
                const sponsorship = allSponsorships.find(s => s.id === id);
                let updateData = {
                    name: name,
                    amount: parseFloat(amount),
                    notes: notes
                };
                
                if (sponsorship && sponsorship.status === 'lost') {
                    updateData.lossReason = document.getElementById('edit-loss-reason').value.trim();
                }


                if (name && amount) {
                    await updateSponsorship(id, updateData);
                    hideEditModal();
                } else {
                    showConfirmationModal('Datos Incompletos', 'Por favor, completa al menos el nombre y el monto.', () => {});
                }
            });

            // Bot√≥n de Eliminar en el modal de Edici√≥n
            document.getElementById('delete-sponsorship-btn').addEventListener('click', () => {
                const id = document.getElementById('edit-sponsorship-id').value;
                const name = document.getElementById('edit-sponsorship-name').value;
                
                // Muestra modal de confirmaci√≥n
                showConfirmationModal(
                    'Confirmar Eliminaci√≥n',
                    `¬øEst√°s seguro de que quieres eliminar permanentemente el patrocinio de <strong>${name}</strong>? Esta acci√≥n no se puede deshacer.`,
                    () => deleteSponsorship(id)
                );
            });
        }

        function showEditModal(id) {
            const sponsorship = allSponsorships.find(s => s.id === id);
            if (!sponsorship) return;

            // Rellenar formulario
            document.getElementById('edit-sponsorship-id').value = id;
            document.getElementById('edit-sponsorship-name').value = sponsorship.name;
            document.getElementById('edit-sponsorship-amount').value = sponsorship.amount || 0;
            document.getElementById('edit-sponsorship-notes').value = sponsorship.notes || '';
            
            const lossReasonContainer = document.getElementById('edit-loss-reason-container');
            const editLossReason = document.getElementById('edit-loss-reason');

            if (sponsorship.status === 'lost') {
                lossReasonContainer.classList.remove('hidden');
                editLossReason.value = sponsorship.lossReason || '';
            } else {
                lossReasonContainer.classList.add('hidden');
                editLossReason.value = '';
            }
            
            // Mostrar modal
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-modal').classList.add('flex');
            document.getElementById('edit-sponsorship-name').focus();
            lucide.createIcons();
        }

        function hideEditModal() {
            document.getElementById('edit-modal').classList.remove('flex');
            document.getElementById('edit-modal').classList.add('hidden');
        }


        // --- DRAG & DROP ---
        function handleDragStart(event) {
            draggedId = event.target.getAttribute('data-id');
            event.dataTransfer.setData('text/plain', draggedId);
            event.target.classList.add('opacity-50');
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(event, newStatus) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const cardElement = document.querySelector(`[data-id="${draggedId}"]`);
            if (cardElement) cardElement.classList.remove('opacity-50');

            // Capturamos el ID antes de limpiarlo globalmente para asegurar que el callback lo tenga.
            const idToUpdate = draggedId;
            if (!idToUpdate) return;

            const currentStatus = cardElement.getAttribute('data-status');
            if (currentStatus === newStatus) return;

            const sponsorship = allSponsorships.find(s => s.id === idToUpdate);
            if (!sponsorship) return;

            // L√≥gica especial para la columna 'lost'
            if (newStatus === 'lost') {
                // **CORRECCI√ìN 2: El callback recibe el motivo de p√©rdida**
                showConfirmationModal(
                    'Confirmar Oportunidad Perdida',
                    `Est√°s a punto de mover <strong>${sponsorship.name}</strong> a la columna PERDIDO. Por favor, especifica el motivo para el an√°lisis futuro:`,
                    // Este callback recibe el 'lossReason' autom√°ticamente del modal
                    (lossReason) => updateSponsorshipStatus(idToUpdate, newStatus, lossReason), 
                    true // Indica que debe mostrar el campo de motivo de p√©rdida
                );
            } else {
                 showConfirmationModal(
                    'Confirmar Cambio',
                    `¬øMover <strong>${sponsorship.name}</strong> a <strong>${getStatusName(newStatus)}</strong>?`,
                    // El callback para otros estados no necesita el lossReason, solo llama a la funci√≥n de estado
                    () => updateSponsorshipStatus(idToUpdate, newStatus) 
                );
            }
            
            // Limpiamos el ID global despu√©s de programar la acci√≥n.
            draggedId = null; 
        }

        function getStatusName(status) {
            const names = {
                'negotiation': 'Propuesta y Negociaci√≥n',
                'pending': 'Acuerdos en Cierre', 
                'paid': '√âxito y Cierre de Capital',
                'lost': 'Oportunidades Perdidas'
            };
            return names[status];
        }

        // --- MODAL DE CONFIRMACI√ìN GENERAL (CORREGIDO Y AJUSTADO) ---
        function showConfirmationModal(title, message, onConfirm, showLossReason = false) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message;
            const modal = document.getElementById('action-modal');
            const lossReasonField = document.getElementById('loss-reason-field');
            const lossReasonInput = document.getElementById('loss-reason');
            const confirmBtn = document.getElementById('modal-confirm');
            
            lossReasonInput.value = ''; // Limpiar campo

            if (showLossReason) {
                lossReasonField.classList.remove('hidden');
                confirmBtn.textContent = 'Confirmar P√©rdida';
                confirmBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                lossReasonField.classList.add('hidden');
                confirmBtn.textContent = 'Confirmar';
                confirmBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                confirmBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            confirmBtn.onclick = () => {
                modal.classList.add('hidden');
                if (onConfirm) {
                    // **CORRECCI√ìN 2: Pasar el valor del motivo de p√©rdida al callback si aplica**
                    if (showLossReason) {
                        onConfirm(lossReasonInput.value.trim());
                    } else {
                        onConfirm(); 
                    }
                }
            };

            document.getElementById('modal-cancel').onclick = () => {
                modal.classList.add('hidden');
            };
        }

        // Funciones globales para HTML
        window.handleDragOver = handleDragOver;
        window.handleDragLeave = handleDragLeave;
        window.handleDrop = handleDrop;
        window.sortColumn = sortColumn;
        window.applyFilter = applyFilter; 

        // Inicializar la aplicaci√≥n al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</body>
</html>
